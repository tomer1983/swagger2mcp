stages:
  - lint
  - test
  - build
  - docker
  - release

variables:
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_DB: swagger2mcp_test
  DATABASE_URL: postgresql://postgres:postgres@postgres:5432/swagger2mcp_test
  REDIS_HOST: redis
  REDIS_PORT: 6379
  NODE_VERSION: "20"

# Cache node_modules for faster builds
cache:
  key:
    files:
      - backend/package-lock.json
      - frontend/package-lock.json
  paths:
    - backend/node_modules/
    - frontend/node_modules/

# Backend Jobs

backend:lint:
  stage: lint
  image: node:${NODE_VERSION}
  before_script:
    - cd backend
    - npm ci
  script:
    - npm run lint || echo "Add lint script to package.json"
  only:
    - main
    - develop
    - merge_requests

backend:typecheck:
  stage: lint
  image: node:${NODE_VERSION}
  before_script:
    - cd backend
    - npm ci
  script:
    - npx tsc --noEmit
  only:
    - main
    - develop
    - merge_requests

backend:test:
  stage: test
  image: node:${NODE_VERSION}
  services:
    - name: postgres:15-alpine
      alias: postgres
    - name: redis:alpine
      alias: redis
  before_script:
    - cd backend
    - npm ci
  script:
    - npm test || echo "Add tests to backend"
  only:
    - main
    - develop
    - merge_requests

backend:build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - cd backend
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - backend/dist/
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

# Frontend Jobs

frontend:lint:
  stage: lint
  image: node:${NODE_VERSION}
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint
  only:
    - main
    - develop
    - merge_requests

frontend:typecheck:
  stage: lint
  image: node:${NODE_VERSION}
  before_script:
    - cd frontend
    - npm ci
  script:
    - npx tsc --noEmit
  only:
    - main
    - develop
    - merge_requests

frontend:test:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm test || echo "Add tests to frontend"
  only:
    - main
    - develop
    - merge_requests

frontend:build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

# Security Audit

security:audit:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd backend && npm audit --audit-level=moderate || true
    - cd ../frontend && npm audit --audit-level=moderate || true
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# Docker Jobs

docker:backend:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    - docker build -t swagger2mcp-backend:latest ./backend
    - docker images swagger2mcp-backend:latest
  only:
    - main
    - develop
    - merge_requests

docker:frontend:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    - docker build -t swagger2mcp-frontend:latest ./frontend
    - docker images swagger2mcp-frontend:latest
  only:
    - main
    - develop
    - merge_requests

docker:compose:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - apk add --no-cache docker-compose
  script:
    - docker-compose config
    - echo "Docker Compose configuration is valid"
  only:
    - main
    - develop
    - merge_requests

# Semantic Release

semantic-release:
  stage: release
  image: node:${NODE_VERSION}
  before_script:
    - npm install -g semantic-release@latest
    - npm install -g @semantic-release/changelog@latest
    - npm install -g @semantic-release/git@latest
    - npm install -g @semantic-release/gitlab@latest
    - npm install -g @semantic-release/commit-analyzer@latest
    - npm install -g @semantic-release/release-notes-generator@latest
  script:
    - npx semantic-release --extends ./.releaserc.gitlab.json
  only:
    - main
    - develop
  except:
    - merge_requests
  variables:
    GL_TOKEN: $CI_JOB_TOKEN
    GITLAB_TOKEN: $CI_JOB_TOKEN
