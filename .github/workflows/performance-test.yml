name: Performance Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  performance-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Setup database
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb
      run: |
        npx prisma generate --schema=backend/prisma/schema.prisma
        npx prisma db push --skip-generate --schema=backend/prisma/schema.prisma
    
    - name: Run performance tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb
      run: |
        node -e "
        const { PrismaClient } = require('@prisma/client');
        const { performance } = require('perf_hooks');

        async function runPerformanceTest() {
          const prisma = new PrismaClient({ datasources: { db: { url: process.env.DATABASE_URL } } });
          
          try {
            console.log('Starting performance tests...');
            
            // Test 1: Create operations
            const createStart = performance.now();
            const users = [];
            for (let i = 0; i < 100; i++) {
              users.push({
                email: \`user\${i}@test.com\`,
                name: \`User \${i}\`
              });
            }
            await prisma.user.createMany({ data: users });
            const createEnd = performance.now();
            console.log(\`Created 100 users in \${(createEnd - createStart).toFixed(2)}ms\`);
            
            // Test 2: Read operations
            const readStart = performance.now();
            const allUsers = await prisma.user.findMany();
            const readEnd = performance.now();
            console.log(\`Read \${allUsers.length} users in \${(readEnd - readStart).toFixed(2)}ms\`);
            
            // Test 3: Update operations
            const updateStart = performance.now();
            for (const user of allUsers.slice(0, 10)) {
              await prisma.user.update({
                where: { id: user.id },
                data: { name: \`Updated \${user.name}\` }
              });
            }
            const updateEnd = performance.now();
            console.log(\`Updated 10 users in \${(updateEnd - updateStart).toFixed(2)}ms\`);
            
            // Test 4: Delete operations
            const deleteStart = performance.now();
            await prisma.user.deleteMany({});
            const deleteEnd = performance.now();
            console.log(\`Deleted all users in \${(deleteEnd - deleteStart).toFixed(2)}ms\`);
            
            console.log('Performance tests completed successfully');
          } catch (error) {
            console.error('Performance test failed:', error);
            process.exit(1);
          } finally {
            await prisma.\$disconnect();
          }
        }

        runPerformanceTest();
        "
    
    - name: Upload performance results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: |
          performance-*.json
          performance-*.log
